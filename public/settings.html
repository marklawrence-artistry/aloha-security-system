<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - Aloha Security</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="../style.css">
    <link rel="stylesheet" href="css/admin.css">
    <style>
        /* Tabs Styling */
        .settings-tabs { display: flex; gap: 20px; border-bottom: 1px solid #ddd; margin-bottom: 30px; }
        .tab-btn { padding: 10px 20px; background: none; border: none; border-bottom: 3px solid transparent; cursor: pointer; font-weight: 600; color: #666; }
        .tab-btn.active { border-color: #e53828; color: #e53828; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .backup-card { border: 1px solid #ddd; padding: 20px; border-radius: 8px; margin-bottom: 20px; background: #fafafa; }
    </style>
</head>
<body>
    <nav class="sidebar">
        <div class="sidebar-brand"><i class="bi bi-shield-check"></i> ALOHA <span>ADMIN</span></div>
        <a href="admin-dashboard.html" class="nav-item"><i class="bi bi-grid-1x2-fill"></i> Dashboard</a>
        <a href="audit-log.html" class="nav-item"><i class="bi bi-clipboard-data-fill"></i> Audit Logs</a>
        <a href="applicants.html" class="nav-item"><i class="bi bi-people-fill"></i> Applicants</a>
        <a href="branches.html" class="nav-item"><i class="bi bi-building-fill"></i> Branches</a>
        <a href="deployment.html" class="nav-item"><i class="bi bi-geo-alt-fill"></i> Deployment</a>
        <a href="users.html" class="nav-item"><i class="bi bi-person-gear"></i> Users</a>
        <a href="settings.html" class="nav-item active"><i class="bi bi-gear-fill"></i> Settings</a>
        <button id="logout-btn" class="nav-item logout-btn border-0 w-100 text-start cursor-pointer"><i class="bi bi-box-arrow-left"></i> Logout</button>
    </nav>

    <main class="main-content">
        <div class="page-header">
            <h1>Settings</h1>
        </div>

        <div class="settings-tabs">
            <button class="tab-btn active" onclick="switchTab('profile')">My Profile</button>
            <button class="tab-btn" onclick="switchTab('system')" id="system-tab-btn">System Maintenance</button>
        </div>

        <!-- TAB 1: PROFILE -->
        <div id="tab-profile" class="tab-content active" style="max-width: 600px;">
            <div style="background: white; padding: 30px; border-radius: 12px; border: 1px solid #ddd;">
                <form id="settings-form">
                    <h4 class="mb-3">Security Settings</h4>
                    <div style="margin-bottom: 15px;">
                        <label style="display:block; margin-bottom:5px; font-weight:600;">Current Password</label>
                        <input type="password" id="curr-pass" required class="search-input" style="width:100%;">
                    </div>
                    <div style="margin-bottom: 30px;">
                        <label style="display:block; margin-bottom:5px; font-weight:600;">New Password</label>
                        <input type="password" id="new-pass" placeholder="Optional" class="search-input" style="width:100%;">
                    </div>

                    <h4 class="mb-3">Recovery Question</h4>
                    <div style="margin-bottom: 15px;">
                        <select id="sec-q" class="search-input" style="width:100%; height: 45px;">
                            <option value="">Select a question...</option>
                            <option value="What is the name of your first pet?">What is the name of your first pet?</option>
                            <option value="What city were you born in?">What city were you born in?</option>
                            <option value="What is your mother's maiden name?">What is your mother's maiden name?</option>
                            <option value="What is the agency name?">What is the agency name?</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <input type="text" id="sec-a" placeholder="Answer" class="search-input" style="width:100%;">
                    </div>

                    <button type="submit" class="btn-hire" style="border:none;">Save Changes</button>
                </form>
            </div>
        </div>

        <!-- TAB 2: SYSTEM (Backup/Restore) -->
        <div id="tab-system" class="tab-content" style="max-width: 600px;">
            
            <!-- Backup Section -->
            <div class="backup-card">
                <h4><i class="bi bi-cloud-download-fill"></i> Backup Data</h4>
                <p class="text-muted small">Download a ZIP file containing the Database and all Uploaded Documents.</p>
                <button onclick="downloadBackup()" class="btn-hire" style="background:#2b6cb0;">Download Backup</button>
            </div>

            <!-- Restore Section -->
            <div class="backup-card" style="border-color: #fbd38d; background: #fffaf0;">
                <h4 style="color: #c05621;"><i class="bi bi-cloud-upload-fill"></i> Restore Data</h4>
                <p class="text-muted small">
                    <strong>WARNING:</strong> This will overwrite the current database and files. 
                    Ensure no one else is using the system.
                </p>
                
                <form id="restore-form">
                    <input type="file" id="backup-file" accept=".zip" required style="margin-bottom: 15px;">
                    <br>
                    <button type="submit" class="btn-reject" style="font-size: 0.9rem;">Upload & Restore</button>
                </form>
            </div>
        </div>
    </main>

    <script src="js/admin.js"></script>
    <script>
        // Check RBAC for Tab Visibility
        document.addEventListener('DOMContentLoaded', () => {
            const role = localStorage.getItem('admin_role');
            if(role !== 'Admin') {
                document.getElementById('system-tab-btn').style.display = 'none';
            }
        });

        // Tab Switcher
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            
            document.getElementById(`tab-${tabName}`).classList.add('active');
            event.target.classList.add('active');
        }

        // 1. Profile Update Logic
        document.getElementById('settings-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const curr = document.getElementById('curr-pass').value;
            const newP = document.getElementById('new-pass').value;
            const q = document.getElementById('sec-q').value;
            const a = document.getElementById('sec-a').value;

            try {
                const res = await fetch('/api/auth/update-profile', {
                    method: 'PUT',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('admin_token')}`
                    },
                    body: JSON.stringify({ 
                        currentPassword: curr,
                        newPassword: newP,
                        newQuestion: q,
                        newAnswer: a
                    })
                });
                const json = await res.json();
                if(json.success) {
                    alert('Profile updated successfully!');
                    document.getElementById('settings-form').reset();
                } else {
                    alert('Error: ' + json.data);
                }
            } catch(err) { alert('Connection error'); }
        });

        // 2. Download Backup Logic
        async function downloadBackup() {
            const token = localStorage.getItem('admin_token');
            // Can't use fetch for file download easily, use window.open with token?
            // Since API is protected, we need to pass token. 
            // Standard approach: fetch -> blob -> objectUrl -> a.click
            try {
                const res = await fetch('/api/system/backup', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if(res.status === 200) {
                    const blob = await res.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `aloha_backup_${new Date().toISOString().slice(0,10)}.zip`;
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                } else {
                    alert("Backup failed. Only Admins can perform this action.");
                }
            } catch(err) { console.error(err); alert("Download error"); }
        }

        // 3. Restore Logic
        document.getElementById('restore-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if(!confirm("DANGER: This will delete current data and replace it with the backup. Continue?")) return;

            const fileInput = document.getElementById('backup-file');
            const formData = new FormData();
            formData.append('backup_file', fileInput.files[0]);

            const btn = e.target.querySelector('button');
            const originalText = btn.innerText;
            btn.innerText = "Restoring... (Do not close)";
            btn.disabled = true;

            try {
                const res = await fetch('/api/system/restore', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('admin_token')}` },
                    body: formData
                });
                const json = await res.json();

                if(json.success) {
                    alert("Restore Successful! The page will now reload.");
                    location.reload();
                } else {
                    alert("Restore Failed: " + json.data);
                }
            } catch(err) {
                alert("Restore failed. Server might be restarting.");
                console.error(err);
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        });
    </script>
</body>
</html>