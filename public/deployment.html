<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deployment - Aloha Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="css/admin.css">
</head>
<body>
    <nav class="sidebar">
        <div class="sidebar-brand">
            <img src="resources/logo.png" alt="Aloha Logo" class="sidebar-logo"> ALOHA <span>ADMIN</span>
        </div>
        
        <div class="sidebar-category">Main Menu</div>
        <a href="admin-dashboard.html" class="nav-item"><i class="bi bi-grid-1x2-fill"></i> Dashboard</a>
        <a href="audit-log.html" class="nav-item"><i class="bi bi-clipboard-data-fill"></i> Audit Logs</a>
        
        <div class="sidebar-category">Operations</div>
        <a href="applicants.html" class="nav-item"><i class="bi bi-people-fill"></i> Applicants</a>
        <a href="branches.html" class="nav-item"><i class="bi bi-building-fill"></i> Branches</a>
        <a href="deployment.html" class="nav-item active"><i class="bi bi-geo-alt-fill"></i> Deployment</a>
        
        <div class="sidebar-category">System</div>
        <a href="users.html" class="nav-item"><i class="bi bi-person-gear"></i> Users</a>
        <a href="settings.html" class="nav-item"><i class="bi bi-gear-fill"></i> Settings</a>
        <button id="logout-btn" class="nav-item logout-btn border-0 w-100 text-start cursor-pointer"><i class="bi bi-box-arrow-left"></i> Logout</button>
    </nav>

    <main class="main-content">
        <div class="page-header">
            <h1>Deployment Management</h1>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="stat-total">-</div>
                <div class="stat-label">Total Deployments</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="stat-active">-</div>
                <div class="stat-label">Currently Active</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="stat-month">-</div>
                <div class="stat-label">Deployed This Month</div>
            </div>
        </div>

        <!-- NEW TABLE CONTAINER STRUCTURE -->
        <div class="table-container deployment">
            <!-- Filter Chips -->
            <div class="filter-container" id="filter-chips">
                <div class="filter-chip active" data-filter="all">
                    <i class="bi bi-grid-fill"></i> All <span class="count-badge" id="count-all">0</span>
                </div>
                <div class="filter-chip" data-filter="Active">
                    <i class="bi bi-person-check-fill"></i> On Duty <span class="count-badge" id="count-Active">0</span>
                </div>
                <div class="filter-chip" data-filter="Ended">
                    <i class="bi bi-person-x-fill"></i> Ended <span class="count-badge" id="count-Ended">0</span>
                </div>
            </div>

            <!-- Toolbar: Search Left, Button Right -->
            <div class="toolbar">
                <div class="toolbar-left">
                    <input type="text" id="search-input" class="search-input" placeholder="Search guard or branch...">
                    <select id="sort-select" class="sort-select" title="Sort deployment records">
                        <option value="desc">Newest First</option>
                        <option value="asc">Oldest First</option>
                    </select>
                </div>
                <div class="toolbar-right" style="display:flex; gap:10px;">
                    <!-- NEW PDF BUTTON -->
                    <button onclick="downloadPdfReport()" class="btn-outline-custom" style="height:42px;">
                        <i class="bi bi-printer-fill"></i> Print Report
                    </button>
                    
                    <a href="deploy-form.html" class="btn-toolbar btn-add">
                        <i class="bi bi-plus-lg"></i> Deploy Guard
                    </a>
                </div>
            </div>

            <!-- Tactical Grid replaces Table -->
            <div class="facility-grid" id="deploy-grid">
                <!-- Cards will be rendered here -->
            </div>

            <!-- Pagination Footer -->
            <div class="pagination-container">
                <span id="page-info" class="text-muted small">Loading...</span>
                <div class="d-flex gap-2">
                    <button id="prev-btn" class="btn-outline-custom" disabled>&lt;</button>
                    <button id="next-btn" class="btn-outline-custom">&gt;</button>
                </div>
            </div>
        </div>
    </main>

    <!-- Core System Scripts -->
    <script src="js/admin.js"></script>
    <script>
        const API_BASE = '/api/deployments';
        let currentFilter = 'all';
        let allDeployments = [];
        let filteredDeployments = [];
        let allBranchesMap = {}; 
        const itemsPerPage = 6; 

        // Override fetchDeployments to handle full data for client-side filtering
        window.fetchDeployments = async function() {
            const searchField = document.getElementById('search-input');
            const sortField = document.getElementById('sort-select');
            const search = searchField ? searchField.value : '';
            const sort = sortField ? sortField.value : 'desc';
            
            try {
                // 1. Fetch Branches for Mini-Map data (Isolated to not block deployments)
                try {
                    const branchRes = await fetch('/api/branches?limit=1000', {
                        headers: { 'Authorization': `Bearer ${getToken()}` }
                    });
                    const branchData = await branchRes.json();
                    if (branchData.success && branchData.data.branches) {
                        allBranchesMap = branchData.data.branches.reduce((acc, b) => {
                            acc[b.id] = { ...b, active_count: 0 };
                            return acc;
                        }, {});
                    }
                } catch (bErr) { console.error("Branch fetch failed:", bErr); }

                // 2. Fetch Deployments
                const res = await fetch(`${API_BASE}?page=1&limit=1000&search=${search}&sort=${sort}`, {
                    headers: { 'Authorization': `Bearer ${getToken()}` }
                });
                const result = await res.json();
                
                if (result.success) {
                    allDeployments = result.data.deployments || [];
                    
                    // Calculate active guard counts per branch manually for tooltips
                    Object.values(allBranchesMap).forEach(b => b.active_count = 0);
                    allDeployments.forEach(d => {
                        if (d.status === 'Active') {
                            const branch = Object.values(allBranchesMap).find(b => b.name === d.branch_name);
                            if (branch) branch.active_count++;
                        }
                    });

                    applyFilters();
                    updateStats(result.data.stats || { total_deployments: 0, total_active: 0, this_month: 0 });
                }
            } catch (err) {
                console.error("Main fetch failed:", err);
                const grid = document.getElementById('deploy-grid');
                if(grid) grid.innerHTML = '<div class="text-center p-5 text-danger">Failed to load data. Please refresh.</div>';
            }
        };

        function applyFilters() {
            const searchField = document.getElementById('search-input');
            const searchQuery = searchField ? searchField.value.toLowerCase() : '';

            filteredDeployments = allDeployments.filter(d => {
                const statusMatch = currentFilter === 'all' || d.status === currentFilter;
                return statusMatch;
            });

            // Update Pagination display
            const totalPages = Math.ceil(filteredDeployments.length / itemsPerPage);
            if (currentPage > totalPages && totalPages > 0) currentPage = totalPages;
            
            updatePagination({
                current_page: currentPage,
                total_pages: totalPages || 1
            });

            // Render current page
            const start = (currentPage - 1) * itemsPerPage;
            const paginatedItems = filteredDeployments.slice(start, start + itemsPerPage);
            renderTable(paginatedItems);
        }

        // Override updatePagination to handle client-side paging
        window.updatePagination = function(pagination) {
            document.getElementById('page-info').innerText = `Page ${pagination.current_page} of ${pagination.total_pages}`;
            document.getElementById('prev-btn').disabled = pagination.current_page === 1;
            document.getElementById('next-btn').disabled = pagination.current_page >= pagination.total_pages;
        };

        // Enhanced Text Highlighting
        function highlightText(text, query) {
            if (!query) return text;
            const regex = new RegExp(`(${query})`, 'gi');
            return text.replace(regex, '<span class="highlight">$1</span>');
        }

        // Override renderTable for Tactical Grid
        window.renderTable = function(data) {
            const grid = document.getElementById('deploy-grid');
            const searchField = document.getElementById('search-input');
            const searchQuery = searchField ? searchField.value : '';

            if (data.length === 0) {
                grid.innerHTML = `
                    <div style="grid-column: 1/-1; padding: 40px; text-align: center; color: #64748b; background: white; border-radius: 16px; border: 1px dashed #cbd5e1;">
                        <i class="bi bi-inbox" style="font-size: 2rem; display: block; margin-bottom: 12px;"></i>
                        No deployments found matching your criteria.
                    </div>
                `;
                return;
            }

            grid.innerHTML = data.map(d => {
                const depDate = new Date(d.date_deployed);
                const now = new Date();
                const diffMs = now - depDate;
                const hrs = Math.floor(diffMs / (1000 * 60 * 60));
                const days = Math.floor(hrs / 24);
                
                let durationText = "";
                let progress = 0;
                
                if (d.status === 'Active') {
                    if (days >= 1) {
                        durationText = `${days} day${days > 1 ? 's' : ''} on duty`;
                        progress = Math.min(100, (days / 30) * 100);
                    } else {
                        durationText = `${hrs} hour${hrs !== 1 ? 's' : ''} on duty`;
                        progress = Math.min(100, (hrs / 24) * 100);
                    }
                } else {
                    durationText = "Service Ended";
                    progress = 100;
                }

                const isNew = d.status === 'Active' && diffMs < (24 * 60 * 60 * 1000);

                return `
                <div class="deployment-card ${isNew ? 'new-entry' : ''}">
                    <div class="tag-container">
                        <div class="card-tag ${d.status === 'Active' ? 'secured' : 'warning'}" style="position:static;">
                            <i class="bi ${d.status === 'Active' ? 'bi-person-check-fill' : 'bi-person-x-fill'}"></i>
                            ${d.status}
                            <div class="tag-tooltip">
                                ${d.status === 'Active' 
                                    ? 'Guard is currently guarding the facility. Deployment is active and ongoing.' 
                                    : 'Guard service for this specific assignment has concluded.'}
                            </div>
                        </div>
                    </div>

                    <div class="guard-profile">
                        <div class="guard-avatar-placeholder">
                            <i class="bi bi-person-fill"></i>
                        </div>
                        <div class="guard-info">
                            <h3>${highlightText(d.first_name + ' ' + d.last_name, searchQuery)}</h3>
                            <div class="branch-link-wrapper">
                                <p style="margin:0; cursor: help;"><i class="bi bi-building"></i> ${highlightText(d.branch_name, searchQuery)}</p>
                                ${(() => {
                                    if (!allBranchesMap || Object.keys(allBranchesMap).length === 0) return '';
                                    const branchMatchName = (bName, dName) => {
                                        const b = bName.trim().toLowerCase();
                                        const d = dName.trim().toLowerCase();
                                        // Fuzzy matching: check if d is a substring of b, or b is a substring of d
                                        return b.includes(d) || d.includes(b);
                                    };
                                    const branch = Object.values(allBranchesMap).find(b => 
                                        branchMatchName(b.name, d.branch_name)
                                    );
                                    if (!branch) return '';
                                    return `
                                    <div class="mini-map-tooltip">
                                        <div class="mini-map-header">
                                            <div class="mini-map-title">
                                                <i class="bi bi-geo-alt-fill"></i> Facility Intel
                                            </div>
                                        </div>
                                        <div class="mini-map-body">
                                            <p><i class="bi bi-map"></i> ${branch.location}</p>
                                            <div class="mini-map-stats">
                                                <div class="mini-stat">
                                                    <span class="mini-stat-val">${branch.active_count || 0}</span>
                                                    <span class="mini-stat-lbl">Active</span>
                                                </div>
                                                <div class="mini-stat">
                                                    <span class="mini-stat-val">${branch.required_guards}</span>
                                                    <span class="mini-stat-lbl">Limit</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    `;
                                })()}
                            </div>
                        </div>
                    </div>

                    <div class="deployment-timeline">
                        <div class="timeline-header">
                            <span>Service Duration</span>
                            <span>${durationText}</span>
                        </div>
                        <div class="timeline-track">
                            <div class="timeline-fill ${d.status !== 'Active' ? 'ended' : ''}" style="width: ${progress}%"></div>
                        </div>
                    </div>

                    <div class="card-footer-actions">
                        <span class="deployment-id">EXP #${d.id}</span>
                        ${d.status === 'Active' 
                            ? `<button onclick="endDeployment(${d.id})" class="btn-outline-custom" style="padding: 6px 14px; color:#ef4444; border-color:#fee2e2; background:#fef2f2; font-size:0.75rem; border-radius:8px;">End Duty</button>` 
                            : '<span class="text-muted small">Status Logged</span>'}
                    </div>
                </div>
                `;
            }).join('');
        };

        // Override updateStats for counts
        window.updateStats = function(stats) {
            document.getElementById('stat-total').innerText = stats.total_deployments;
            document.getElementById('stat-active').innerText = stats.total_active;
            document.getElementById('stat-month').innerText = stats.this_month;
            
            document.getElementById('count-all').innerText = stats.total_deployments;
            document.getElementById('count-Active').innerText = stats.total_active;
            document.getElementById('count-Ended').innerText = stats.total_deployments - stats.total_active;
        };

        // Filter Chips Listener
        document.getElementById('filter-chips').addEventListener('click', (e) => {
            const chip = e.target.closest('.filter-chip');
            if (!chip) return;

            document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
            chip.classList.add('active');
            currentFilter = chip.getAttribute('data-filter');
            currentPage = 1;
            applyFilters();
        });

        // Pagination Listeners (re-bind since we handle them locally now)
        document.getElementById('prev-btn').addEventListener('click', (e) => {
            e.stopImmediatePropagation();
            if(currentPage > 1) {
                currentPage--;
                applyFilters();
            }
        });
        document.getElementById('next-btn').addEventListener('click', (e) => {
            e.stopImmediatePropagation();
            const totalPages = Math.ceil(filteredDeployments.length / itemsPerPage);
            if(currentPage < totalPages) {
                currentPage++;
                applyFilters();
            }
        });

        document.getElementById('logout-btn').addEventListener('click', () => {
            localStorage.removeItem('admin_token');
            window.location.href = 'login.html';
        });

        async function endDeployment(id) {
            if(!confirm("Are you sure you want to end this guard's deployment?")) return;

            try {
                const res = await fetch(`${API_BASE}/${id}`, {
                    method: 'PUT',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getToken()}` 
                    },
                    body: JSON.stringify({ status: 'Ended' })
                });
                const result = await res.json();
                if(result.success) {
                    if (typeof showToast === 'function') {
                        showToast('Duty Ended', 'Guard record has been updated.');
                    }
                    fetchDeployments();
                }
            } catch(err) {
                console.error(err);
            }
        }

        // Explicit Initializations
        if (typeof currentPage === 'undefined') window.currentPage = 1;
        
        // Ensure initial fetch runs reliably
        if (document.readyState === 'complete' || document.readyState === 'interactive') {
            fetchDeployments();
        } else {
            document.addEventListener('DOMContentLoaded', fetchDeployments);
        }

        async function downloadPdfReport() {
            const btn = document.querySelector('button[onclick="downloadPdfReport()"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Generating...';
            btn.disabled = true;

            try {
                const res = await fetch('/api/deployments/report/pdf', {
                    method: 'GET',
                    headers: { 
                        'Authorization': `Bearer ${getToken()}` 
                    }
                });

                if (res.ok) {
                    // Convert response to blob
                    const blob = await res.blob();
                    const url = window.URL.createObjectURL(blob);
                    
                    // Create invisible link and click it
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `aloha_deployment_report_${new Date().toISOString().slice(0,10)}.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                    window.URL.revokeObjectURL(url);
                } else {
                    alert("Failed to generate report. Only admins can perform this action.");
                }
            } catch (err) {
                console.error(err);
                alert("Error downloading report.");
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>