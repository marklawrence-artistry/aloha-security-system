<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Branch Management - Aloha Security</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="../style.css">
    <link rel="stylesheet" href="css/admin.css">
</head>
<body>
    <div id="toast-container" class="toast-container"></div>
    <nav class="sidebar">
        <div class="sidebar-brand">
            <i class="bi bi-shield-check"></i> ALOHA <span>ADMIN</span>
        </div>
        <a href="admin-dashboard.html" class="nav-item"><i class="bi bi-grid-1x2-fill"></i> Dashboard</a>
        <a href="audit-log.html" class="nav-item"><i class="bi bi-clipboard-data-fill"></i> Audit Logs</a>
        <a href="applicants.html" class="nav-item"><i class="bi bi-people-fill"></i> Applicants</a>
        <a href="branches.html" class="nav-item active"><i class="bi bi-building-fill"></i> Branches</a>
        <a href="deployment.html" class="nav-item"><i class="bi bi-geo-alt-fill"></i> Deployment</a>
        <a href="users.html" class="nav-item"><i class="bi bi-person-gear"></i> Users</a>
        <a href="settings.html" class="nav-item"><i class="bi bi-gear-fill"></i> Settings</a>
        <button id="logout-btn" class="nav-item logout-btn border-0 w-100 text-start cursor-pointer"><i class="bi bi-box-arrow-left"></i> Logout</button>
    </nav>

    <main class="main-content">
        <div class="page-header">
            <h1>Branches</h1>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="total-branches">-</div>
                <div class="stat-label">Total Branches</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="total-locations">-</div>
                <div class="stat-label">Total Locations</div>
            </div>
        </div>

        <div class="branches-view-container">
            <div id="filter-chips" class="filter-container">
                <div class="filter-chip active" data-filter="all">
                    <i class="bi bi-grid-fill"></i> All <span class="count-badge" id="count-all">0</span>
                </div>
                <div class="filter-chip" data-filter="secured">
                    <i class="bi bi-shield-fill-check"></i> Fully Secured <span class="count-badge" id="count-secured">0</span>
                </div>
                <div class="filter-chip" data-filter="personnel">
                    <i class="bi bi-exclamation-triangle-fill"></i> Needs Personnel <span class="count-badge" id="count-personnel">0</span>
                </div>
                <div class="filter-chip" data-filter="critical">
                    <i class="bi bi-lightning-fill"></i> Critical <span class="count-badge" id="count-critical">0</span>
                </div>
            </div>

            <div class="toolbar">
                <div class="toolbar-left">
                    <input type="text" id="search-input" class="search-input" placeholder="Search branches...">
                </div>

                <div class="toolbar-right">
                    <select id="sort-select" class="sort-select" title="Sort branches by date">
                        <option value="desc">Newest First</option>
                        <option value="asc">Oldest First</option>
                    </select>
            
                    <button id="multi-delete-btn" class="btn-reject" style="display: none;">
                        <i class="bi bi-trash"></i> Delete Selected
                    </button>
                    
                    <button onclick="openModal()" class="btn-toolbar btn-add">
                        <i class="bi bi-plus-lg"></i> Add New
                    </button>
                </div>
            </div>

            <div id="facility-grid" class="facility-grid">
                <!-- Cards injected here via JS -->
                <div class="loading-state">Loading facilities...</div>
            </div>

            <!-- Keep hidden table body for multi-delete script compatibility if needed -->
            <table style="display:none;"><tbody id="branches-body"></tbody></table>

            <div class="pagination-container">
                <span id="page-info" class="text-muted small">Loading...</span>
                <div class="d-flex gap-2">
                    <button id="prev-btn" class="btn-outline-custom" disabled>&lt;</button>
                    <button id="next-btn" class="btn-outline-custom">&gt;</button>
                </div>
            </div>
        </div>
    </main>

    <!-- 3. Premium Tabbed Modal -->
    <div id="branch-modal" class="modal-system" style="display:none;">
        <div class="modal-overlay" onclick="closeModal()"></div>
        <div class="modal-content-wrapper">
            <div class="modal-header-premium">
                <div class="header-main">
                    <h2 id="modal-title">Add New Branch</h2>
                    <p class="header-sub">Configure facility security operational parameters.</p>
                </div>
                <button type="button" class="btn-close-modal" onclick="closeModal()"><i class="bi bi-x"></i></button>
            </div>

            <div class="modal-tabs">
                <button type="button" class="tab-btn active" onclick="switchTab('location')">
                    <i class="bi bi-geo-alt"></i> Location
                </button>
                <button type="button" class="tab-btn" onclick="switchTab('personnel')">
                    <i class="bi bi-shield-shaded"></i> Personnel
                </button>
            </div>

            <form id="branch-form">
                <input type="hidden" id="branch-id">
                
                <div class="tab-content">
                    <!-- Tab 1: Location -->
                    <div id="tab-location" class="tab-pane active">
                        <div class="form-group-premium">
                            <label><i class="bi bi-tag"></i> Branch Designation</label>
                            <input type="text" id="branch-name" placeholder="e.g. Quezon City North Hub" required>
                        </div>
                        <div class="form-group-premium">
                            <label><i class="bi bi-map"></i> Physical Address</label>
                            <input type="text" id="branch-location" placeholder="Street, City, Postal Code" required>
                        </div>
                    </div>

                    <!-- Tab 2: Personnel -->
                    <div id="tab-personnel" class="tab-pane">
                        <div class="form-group-premium">
                            <label><i class="bi bi-people"></i> Required Guard Count</label>
                            <div class="input-with-hint">
                                <input type="number" id="branch-guards" min="1" value="1" required>
                                <span class="input-hint">Minimum personnel needed for 24/7 security.</span>
                            </div>
                        </div>
                        <div class="info-alert">
                            <i class="bi bi-info-circle"></i> Deployment alerts will be sent if the count falls below this threshold.
                        </div>
                    </div>
                </div>

                <div class="modal-footer-premium">
                    <button type="button" class="btn-cancel-premium" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn-save-premium">
                        <i class="bi bi-check-circle"></i> Save Framework
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script src="js/admin.js"></script>
    <script src="js/branches.js"></script>
    <script>
        // --- UNIVERSAL MULTI-DELETE OVERRIDE ---
        // We override the global function to use our Premium Toast system
        const originalSetupMultiDelete = window.setupMultiDelete;
        window.setupMultiDelete = function(config) {
            const tbody = document.getElementById(config.tableBodyId);
            const deleteBtn = document.getElementById(config.deleteBtnId);
            const container = config.containerId ? document.getElementById(config.containerId) : deleteBtn;
            const checkAll = document.getElementById(config.checkAllId);

            if (!tbody || !deleteBtn) return;

            const getSelectedIds = () => Array.from(tbody.querySelectorAll('.row-checkbox:checked')).map(cb => cb.value);

            deleteBtn.addEventListener('click', async () => {
                const ids = getSelectedIds();
                if (ids.length === 0) return;

                const warning = `Are you sure you want to delete ${ids.length} ${config.entityName || 'items'}?`;
                if (!confirm(warning)) return;

                deleteBtn.disabled = true;
                const token = getToken();

                const deletePromises = ids.map(id => 
                    fetch(`${config.apiBaseUrl}/${id}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${token}` }
                    }).then(res => res.json())
                );

                const results = await Promise.all(deletePromises);
                const success = results.filter(r => r.success).length;
                const failed = results.length - success;

                if (success > 0) {
                    showToast('Deleted', `${success} facility records removed successfully`);
                }
                if (failed > 0) {
                    showToast('Conflict', `${failed} records could not be deleted (Guards deployed)`, 'warning');
                }

                if (checkAll) checkAll.checked = false;
                if (container) container.style.display = 'none';
                deleteBtn.disabled = false;
                if (config.onSuccess) config.onSuccess();
            });

            // Call original to set up standard checkbox listeners (harmless to double-bind updateVisibility)
            if (originalSetupMultiDelete) originalSetupMultiDelete(config);
        };

        // --- FACILITY CARDS OVERRIDE ---
        // --- TOAST SYSTEM ---
        function showToast(title, message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `premium-toast ${type}`;
            
            const icons = {
                success: 'bi-check-circle-fill',
                error: 'bi-exclamation-octagon-fill',
                warning: 'bi-exclamation-triangle-fill'
            };

            toast.innerHTML = `
                <div class="toast-icon"><i class="bi ${icons[type]}"></i></div>
                <div class="toast-content">
                    <h4 class="toast-title">${title}</h4>
                    <p class="toast-message">${message}</p>
                </div>
                <div class="toast-progress"><div class="toast-progress-fill"></div></div>
            `;

            container.appendChild(toast);

            // Progress bar animation
            const progressFill = toast.querySelector('.toast-progress-fill');
            progressFill.style.transition = 'width 3s linear';
            requestAnimationFrame(() => progressFill.style.width = '0%');

            setTimeout(() => {
                toast.classList.add('fade-out');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // --- ENHANCED DISCOVERY ---
        let currentFilter = 'all';

        function highlightText(text, query) {
            if (!query) return text;
            const regex = new RegExp(`(${query})`, 'gi');
            return text.replace(regex, '<span class="highlight">$1</span>');
        }

        document.getElementById('filter-chips').addEventListener('click', (e) => {
            const chip = e.target.closest('.filter-chip');
            if (!chip) return;

            document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
            chip.classList.add('active');
            currentFilter = chip.getAttribute('data-filter');
            fetchBranches(); // Re-fetch or re-render
        });

        // --- FACILITY CARDS OVERRIDE ---
        const originalRenderTable = window.renderTable;
        window.renderTable = async function(branches) {
            // Fetch real deployment data to calculate accurate status and get personnel names
            let deploymentCounts = {};
            let personnelMap = {}; // Group personnel names by branch
            
            try {
                const depRes = await fetch('/api/deployments?limit=1000', {
                    headers: { 'Authorization': `Bearer ${getToken()}` }
                });
                const depData = await depRes.json();
                if (depData.success) {
                    depData.data.deployments.forEach(d => {
                        if (d.status === 'Active') {
                            deploymentCounts[d.branch_name] = (deploymentCounts[d.branch_name] || 0) + 1;
                            
                            if (!personnelMap[d.branch_name]) personnelMap[d.branch_name] = [];
                            personnelMap[d.branch_name].push(`${d.first_name} ${d.last_name}`);
                        }
                    });
                }
            } catch (err) {
                console.error("Failed to fetch deployment stats:", err);
            }

            if (originalRenderTable) originalRenderTable(branches);

            const grid = document.getElementById('facility-grid');
            if (!grid) return;

            // Pre-calculate status for filtering and counts
            const branchesWithStatus = branches.map(b => {
                const assigned = deploymentCounts[b.name] || 0;
                const percent = (assigned / b.required_guards) * 100;
                return {
                    ...b,
                    assigned,
                    percent,
                    isFullySecured: percent >= 100,
                    isCritical: percent < 50
                };
            });

            // Update Counts on Chips (Based on full data)
            document.getElementById('count-all').innerText = branchesWithStatus.length;
            document.getElementById('count-secured').innerText = branchesWithStatus.filter(b => b.isFullySecured).length;
            document.getElementById('count-personnel').innerText = branchesWithStatus.filter(b => !b.isFullySecured).length;
            document.getElementById('count-critical').innerText = branchesWithStatus.filter(b => b.isCritical).length;

            // Apply Status Filter
            let filtered = branchesWithStatus;
            if (currentFilter === 'secured') filtered = filtered.filter(b => b.isFullySecured);
            else if (currentFilter === 'personnel') filtered = filtered.filter(b => !b.isFullySecured);
            else if (currentFilter === 'critical') filtered = filtered.filter(b => b.isCritical);

            if (filtered.length === 0) {
                grid.innerHTML = '<div class="no-data">No facilities found for this filter.</div>';
                return;
            }

            const searchQuery = document.getElementById('search-input').value.trim();

            grid.innerHTML = filtered.map(b => {
                const assigned = b.assigned;
                const percent = Math.min(b.percent, 100);
                const isFullySecured = b.isFullySecured;
                const guardsList = personnelMap[b.name] || [];

                return `
                    <div class="facility-card" data-id="${b.id}" onclick="toggleCardSelection(this, event)">
                        <div class="selection-overlay">
                            <input type="checkbox" class="card-checkbox" value="${b.id}" onclick="event.stopPropagation()">
                            <i class="bi bi-check-circle-fill"></i>
                        </div>
                        <div class="tag-container">
                            ${isFullySecured ? `
                                <div class="card-tag secured">
                                    <i class="bi bi-shield-fill-check"></i> Fully Secured
                                    <div class="tag-tooltip">Facility has reached optimal staffing levels. No immediate action required.</div>
                                </div>
                            ` : `
                                <div class="card-tag warning">
                                    <i class="bi bi-exclamation-triangle-fill"></i> Needs Personnel
                                    <div class="tag-tooltip">Facility is understaffed. New guard deployments are recommended.</div>
                                </div>
                                ${b.percent < 50 ? `
                                    <div class="card-tag critical">
                                        <i class="bi bi-lightning-fill"></i> Critical State
                                        <div class="tag-tooltip">High Priority: Facility is operating at less than 50% capacity. Deployment required immediately.</div>
                                    </div>
                                ` : ''}
                            `}
                        </div>
                        
                        <div class="facility-icon">
                            <i class="bi bi-building"></i>
                        </div>

                        <div class="facility-header">
                            <h3 class="facility-name">${highlightText(b.name, searchQuery)}</h3>
                            <p class="facility-location"><i class="bi bi-geo-alt"></i> ${b.location}</p>
                        </div>

                        <div class="capacity-info">
                            <div class="capacity-labels">
                                <span>Deployment Status</span>
                                <span>${assigned}/${b.required_guards} Guards</span>
                            </div>
                            <div class="capacity-track">
                                <div class="capacity-fill grow-animate" data-percent="${percent}" style="width: 0%;"></div>
                            </div>
                            
                            <div class="personnel-tooltip">
                                <div class="tooltip-header">
                                    <i class="bi bi-shield-shaded"></i> Active Personnel
                                </div>
                                <ul class="personnel-list">
                                    ${guardsList.length > 0 
                                        ? guardsList.map(name => `<li class="personnel-item"><i class="bi bi-person-fill"></i> ${name}</li>`).join('') 
                                        : '<li class="personnel-item" style="opacity: 0.5;">No guards deployed</li>'}
                                </ul>
                            </div>

                            ${!isFullySecured ? `
                                <div style="margin-top: 10px; text-align: right;">
                                    <a href="deploy-form.html" class="deploy-shortcut" onclick="event.stopPropagation()" style="font-size: 0.75rem; color: #10b981; font-weight: 700; text-decoration: none;">
                                        <i class="bi bi-person-plus"></i> Deploy Guard
                                    </a>
                                </div>
                            ` : ''}
                        </div>

                        <div class="facility-actions">
                            <button onclick="event.stopPropagation(); editBranch(${b.id}, '${b.name}', '${b.location}', ${b.required_guards})" class="btn-card-edit">
                                <i class="bi bi-pencil-square"></i> Edit Details
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

            // Trigger grow animation
            requestAnimationFrame(() => {
                document.querySelectorAll('.grow-animate').forEach(el => {
                    el.style.width = el.getAttribute('data-percent') + '%';
                });
            });
        };

        function toggleCardSelection(card, event) {
            // Don't toggle if clicking a button
            if (event.target.closest('button')) return;
            
            const checkbox = card.querySelector('.card-checkbox');
            checkbox.checked = !checkbox.checked;
            card.classList.toggle('is-selected', checkbox.checked);

            // Sync with the hidden actual checkboxes for multi-delete script
            const hiddenCheckbox = document.querySelector(`#branches-body input[value="${checkbox.value}"]`);
            if (hiddenCheckbox) {
                hiddenCheckbox.checked = checkbox.checked;
                // Manually trigger change event so the multi-delete script sees it
                hiddenCheckbox.dispatchEvent(new Event('change', { bubbles: true }));
            }
        }

        // --- MODAL & TAB LOGIC ---
        function switchTab(tabId) {
            document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            
            document.getElementById(`tab-${tabId}`).classList.add('active');
            document.querySelector(`.tab-btn[onclick*="${tabId}"]`).classList.add('active');
        }

        // We also override openModal and editBranch to ensure they reset tabs
        const originalOpenModal = window.openModal;
        window.openModal = function() {
            if (originalOpenModal) originalOpenModal();
            document.getElementById('branch-modal').style.display = 'flex';
            switchTab('location');
        };

        const originalCloseModal = window.closeModal;
        window.closeModal = function() {
            if (originalCloseModal) originalCloseModal();
            document.getElementById('branch-modal').style.display = 'none';
        };

        const originalEditBranch = window.editBranch;
        window.editBranch = function(id, name, location, guards) {
            if (originalEditBranch) originalEditBranch(id, name, location, guards);
            document.getElementById('branch-modal').style.display = 'flex';
            switchTab('location');
        };

        // Override handleFormSubmit to use Toasts
        window.handleFormSubmit = async function(e) {
            e.preventDefault();
            const id = document.getElementById('branch-id').value;
            const name = document.getElementById('branch-name').value;
            const location = document.getElementById('branch-location').value;
            const guards = document.getElementById('branch-guards').value;

            const method = id ? 'PUT' : 'POST';
            const url = id ? `/api/branches/${id}` : '/api/branches';

            try {
                const res = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getToken()}`
                    },
                    body: JSON.stringify({ name, location, required_guards: guards })
                });
                
                if (res.ok) {
                    closeModal();
                    fetchBranches();
                    showToast('Success', id ? 'Branch details updated' : 'New facility created');
                } else {
                    const error = await res.json();
                    showToast('Error', error.data || 'Operation failed', 'error');
                }
            } catch (err) {
                console.error(err);
                showToast('Error', 'Connection failed', 'error');
            }
        };

        // Override deleteBranch to use Toasts
        window.deleteBranch = async function(id) {
            // We use standard confirm for safety, but toast for the result
            if (!confirm('Are you sure you want to delete this branch?')) return;
            
            try {
                const res = await fetch(`/api/branches/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${getToken()}` }
                });
                const result = await res.json();
                
                if (res.ok) {
                    fetchBranches();
                    showToast('Deleted', 'Facility has been removed');
                } else {
                    showToast('Conflict', result.data || 'Cannot delete branch', 'warning');
                }
            } catch (err) {
                showToast('Error', 'Failed to delete', 'error');
            }
        };

        document.getElementById('logout-btn').addEventListener('click', () => {
            localStorage.removeItem('admin_token');
            window.location.href = 'login.html';
        });
    </script>
</body>
</html>